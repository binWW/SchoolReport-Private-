# 第一章
## 课题来源
    
## 目的和意义
 - 神经元在人类及其他哺乳类动物的大脑系统中起到了至关重要的关键作用。神经元形态学的研究对于理解大脑的结构功能关系及信息处理方式至为关键。研究单个神经元的 3D 形态能够更精确地理解神经元的传输机制和功能，包括神经元表型，连通性，突触整合，触发性能，以及最终在神经网络中的作用。因此，研究单个神经元的 3D 形态对于理解脑功能是十分重要的，一旦产生一个较优的解决方案将对神经科学产生重大影响。 更深入地了解大脑内部的基本连接也有可能导致对脑部疾病认识的突破，并为治疗开辟新的途径。神经科学的最终目标是了解神经系统的工作机制，这就需要提取神经网络中各个神经元的形态结构，进而得到真实的神经元网络的形态学结构。近年，随着光学显微镜技术和细胞染色技术的不断发展，得到的神经元形态数据量也随之大幅增长。然而，生物学家不得不依靠手动或半自动方法将显微镜扫描图像转换为形态学模型。鉴于神经系统中神经元的数量，这项工作势必具有极高的挑战性和复杂性，因此，一个高效、准确、便捷的重建方法对神经科学的发展至关重要。

 - 多维度的显微镜图像是当前生物学研究领域不可或缺的重要数据来源。最近，许多研究致力于开发基于光学显微镜图像的自动或半自动神经元重建算法。然而，在这领域的研究仍然是非常具有挑战性的。目前，已有的大多数算法都存在不同的缺陷，比如对噪声
敏感，不适用于GB 级图像，不适用于结构复杂图像等等，或者需要复杂且较为严格的人为干预等等。因此，希望能够通过研究，创新神经元图像数据的分析与交互方法，提出创新的神经元重建方法，使得研究者可以更加高效、精确、便捷的从基于显微镜扫描的神经元图像数据中的到神经元形态结构的数字化表示，进而促进神经元形态学的研究。
 - 近年来，虚拟现实技术的飞速发展和大热，吸引着无数投资人，创业者，普通消费者以及研究人员的注意力。虚拟现实是人们利用人机交互设备，把操作者与计算机生成的三维虚拟环境连结在一起。操作者通过人机交互设备，以自然的方式(如头的转动、手的运动等)向计算机送入各种动作信息，并且通过视觉、听觉以及触觉等多种感知获得三维感觉世界的技术。  
 -     往往不足以观察复杂的3D结构和发现3D或更高维度图像中的多个对象（例如，细胞）之间的关系。 因此，需要有效的工具来准确地探索3D和多维的图像数据以及基于这些图像数据得到的相应的“重建”对象。

## 国内外研究概况
### 国内
国内关于利用计算机与算法进行神经元形态重建的研究相对较少，(还是搜索一下简单介绍一下吧)
蔺想红等人在2017年提出了一种三位神经元几何形态的发育生成方法，采用人工基因组对基因调控网络进行编码，用基因表达的动态特性来表示神经元树突树的发育过程。[蔺想红, 赵吉昌, 李志强,等. 三维神经元几何形态的发育生成方法[J]. 计算机工程, 2017, 43(10):302-309.] _(要改成自己的话)
### 国外
 - Big Neuron计划/项目
 - 之前做的一些ppt的总结
 
## 论文的主要研究内容
    - 本 论 文一共分 为五 章 内 容，每一 章的主 要内 容为：
    - 第一章 绪 论，本章节首先介绍了本论文选题的课题来源和选题的背景和重要意义，其次对神经元几何形态重建的国内外研究现状作出概述；之后，简单介绍了虚拟现实技术的发展和研究意义；最后是关于本论文结构安排的介绍。
    - 第二章介绍了本文应用的开发平台（Vaa3D平台） 和 使用到的关键技术（虚拟现实技术）。
    - 第三章首先介绍将MS与K-means聚类组合起来的分割算法，充 分利 用MS算 法与K-means算 法的优 势，先使 用MS进行预 分 割，再利用K-means进行聚类分 割，另一方面，在K-means聚 类算 法的基 础上进行改 进：分别采用不同的距离计算方式；合并聚类后相同以及相似的聚类中心使聚类结果更稳定。然后介绍基于CBH颜色重心空间的K-means聚类算法，首先将RGB三维空间转换至CBH一维空间，再利用K-means进行聚类分割。
    - 第四章主要是实验结果的对比与分析。首先是对算法改进前后的效果对比与分析，然后是将这两种算法的分割结果进行横向对比与分析，最后通过这些比较与分析验证所使用算法的优越性。
    第五章主要是对本文所做的工 作内 容进行总 结，并展望接下来的研究方 向。    

# 第二章 背景介绍

## Vaa3D平台
### Vaa3D平台介绍
 - 3D可视化分析工具(3D Visualization-assisted analysis),英文简称为Vaa3D,中文简称为挖三维，是一个方便，快速，多功能的3D / 4D / 5D图像可视化和分析系统。该系统台的主要目标是提供一个跨平台的开源的图形界面平台，可以用于大规模多维度的图像数据的可视化和定量分析，以方便和促进生物学和医学研究。Vaa3D平台支持一个非常简单但强大的插件接口，因此可以轻松地得到拓展和增强。
 - Vaa3D是跨平台的，支持Mac,Window和Linux系统。它可以显示大型或者超大型(GB甚至TB级别)的3D图像数据和3D表面数据。Vaa3D也囊括了多个功能强大的模块致力于3D图像分析（细胞分割，神经元追踪，脑配准，定量测量和统计等）和数据管理。
 - Vaa3D 具有以下几个显著特征，包括（i）多维度图像数据的可视化，（ii）3D图像对象的构件和定量测量，（iii）多个3D图像的比较，融合和管理，（iv）异构图像和其相应的表面结构的可视化，以及（v）使用其插件界面扩展更多的Vaa3D功能。
 - Vaa3D平台基于三种自动化流水线将多种实现图像可视化以及定量分析的复杂应用集成到自身平台中，这三种自动流水线分别是（i）各种图像数据的聚类、分割和3D表面重建的自动化流水线，（ii）3D图像拼接融合的自动化流水线，（iii）用于神经元细胞形态重建、量化和比较分析的自动化流水线。
 - 简而言之，Vaa3D适用于各种生物图像信息学应用，并为开发新的高并发量的3D图像分析算法提供了一个很棒的平台。Vaa3D平台简化了可视化分析的工作流程。
 - **图1** Vaa3D平台主界面
 - **图2** Vaa3D平台显示3D image
 - **图3** Vaa3D平台的重建示例
 
## 研究领域目前的几种常用算法

### allpathpruning1&2
### TreMap
### neutube2
### 神经网络

## 虚拟现实
关于虚拟现实的定义有很多不同的说法，大致可以总结为：虚拟现实是由计算机创造的类似真实世界一样的虚拟世界，人们可以在其中像在体验真实世界一样的去体验和交互[2]。  
虚拟现实概念和虚拟现实技术在经历的20世纪中期的缓慢发展阶段之后，在20世纪90年代进入大爆炸时期，期间成立了许多著名的虚拟现实产业相关的公司，比如Division，Virtuality，Fakespace[2]。各式各样的电影，书籍，会议也都开始涉及虚拟现实的研究内容。然而由于当属的技术还不够成熟，这段热潮期很快就消散了。直到2012年，Oculus VR公司成立，并随后发售了一款VR硬件产品，Oculus Rift，很快吸引了众多大型企业和媒体机构的注意，标志着虚拟现实的时代再次来临[3]。  
在当前的VR竞争市场上，有三家公司牢牢占据这业界“三巨头”的位置，分别是开发Oculus Rift的Oculus VR公司（现已经被Facebook收购），联合开发HTC Vive的HTC与Valve公司，以及开发PSVR的索尼公司。这三家公司的产品各具优势，紧紧把握着高端VR市场。  
虚拟现实应用现在已经涵盖了我们生活的方方面面，包括：
 - 培训教育。医疗手术培训，汽车维修培训，火车驾驶培训等危险性较高或成本较高的培训可以使用虚拟现实技术来规避这些缺点。
 - 运动健身。辅以虚拟现实技术的运动可以让使用者足不出户体验到多种“真实”的运动体验。
 - 游戏娱乐。VR游戏应用占到了当前所有VR应用的60% 以上。辅以虚拟现实技术的游戏能够给玩家带来更完美的体验。
 - 广告、
 - 电影、
 - 直播等娱乐活动。  
---
虚拟现实技术为人们获取信息方式提供了一次极大的更新，不同于移动互联网和手机让人们可以随时随地的获取外界信息，而是让人们更进一步身历其境地获取信息。随着越来越多的创业者和开发者进入虚拟现实领域，相信虚拟现实技术会越来越成熟，越来越亲近消费者。

# 第三章 Vaa3D平台中虚拟现实显示与交互的引入  
## 系统设计  

 - 系统设计目标  
        原始的Vaa3D平台中，虽然已经可以显示并处理3D医学图像，但始终是在2D屏幕上操作3D的模型/图像，难以直观地从各个角度观察3D图像，使用鼠标对图像进行平移旋转缩放等操作十分的笨拙，更难以对图像的某个位置进行精确的定位与进一步的标记操作。 因此我们预想为Vaa3D 平台引入新型的显示方式，即将这些3D医学图像显示在虚拟现实环境中，可以更为直观地观察到整个3D图像的立体结构，即便没有实现任何的图像平移旋转操作，也可以通过在虚拟现实环境中的任意走动与VR头盔角度的任意变换，十分方便的就能观察到3D图像各个角度各个维度的图像特征。 更何况我们还可以在虚拟现实环境中直接对3D图像进行各种直观操作，例如通过手柄对3D图像进行平移旋转缩放等操作，结合用户走动与VR头盔的旋转，极大地方便了用户对3D图像的各个维度各个角度的观察，提升了用户的使用体验，进一步提升用户的工作效率。另一方面，我们预想为Vaa3D平台在虚拟现实环境中引入新型的交互方式，使得之前在2D屏幕上通过鼠标键盘能够实现的操作，例如 trace one single neuron，define a marker, edit one single neuron等 都能够在虚拟现实环境中实现，甚至某些操作在引入虚拟现实环境中后能得到优化，进一步提升用户的工作效率。
 - 系统设计架构  
    本系统设计使用典型的三层架构，即：
    1)	应用表现层(UI):主要是指用于与用户进行交互的界面。用于接收用户从VR手柄控制器的输入和交互操作。
    2)	业务逻辑层(BLL):应用表现层和数据访问层之间的桥梁。实现各种功能交互逻辑。功能交互逻辑具体包含：手柄交互处理，数据更新，多种消息响应等等。
    3)	数据访问层(DAL):与底层数据进行交互。主要实现对数据的增、删、改、查。将底层数据提交给业务层，同时将业务层处理的最新数据保存到底层数据。
    本虚拟现实系统的系统架构图如图2.1所示。

    画一个系统架构图
 - 系统需求分析图****
 - 应用界面设计
 - 手柄UI设计

## 系统实现  

### 显示

 - Vaa3d 中的数据结构
    - 3D image
        Vaa3D平台支持读取多种格式的图像源文件，并且支持2D、3D，4D以及5D图像源数据的读取和可视化。在本虚拟现实系统中，所需要显示的大多数为三维图像，常用的三维图像源文件格式包括：Tiff stack (.tif, .tiff)；Zeiss LSM (.lsm);MRC (used for electron microscopy images) (.mrc);以及Vaa3D平台中输出的图像源文件格式(.v3draw, .raw, *.v3dpbd, *.vaa3dpbd)等。以上这些格式的三维图像均能够在本虚拟现实系统中正常高效地显示。
    - SWC 
        神经元形态重建的流程中，以图象为输入，最终得到一个树状结构的数据，这种数据结构一般被存储在SWC格式文件(.swc)中。SWC文件是一种通用的神经元重建结果的存储格式。从数学角度来看，SWC文件中的数据结构可以描述为节点的集合。此集合中，不允许存在环路，至多存在一条从一个节点到另一个节点的路径（不重复）。SWC文件中的实际数据结构如**表格和图**所示。
``` 表格
    ##n,type,x,y,z,radius,parent
    1 274 286.439 68.8652 448.123 3 -1
    2 274 284.487 68.4821 444.265 3 1
    3 274 280.128 63.78 437.698 2 2
    4 274 274.095 61.308 430.314 1 3
    5 274 266.755 64.6307 427.101 2 4
```
        在**表**中，每一行表示SWC文件中的一个节点，节点的集合构成了一颗完整的节点树。第一列"n"表示此节点的序号(以1为起始点，但不一定表示头节点。)，SWC文件中的每个结点的序号都是唯一的不重复的，保证此节点的集合中不会存在环路。第二列"type"表示节点的类型。不同类型的节点拥有不同的意义，例如节点类型为1(node.type = 1)表示此节点属于神经元轴突部分，节点类型为2(node.type = 2)表示节点属于神经元树突部分。不同类型的节点在Vaa3D平台可视化时以不同颜色来显示以进行区分。第三至五列"x,y,z"表示此节点在空间中的3D位置，一般以保留两位小数 的浮点数表示。第六列"radius"表示节点的大小，形式上表现为显示整条节点树的3D Surface模式时此节点的半径。第七列"parent"表示此节点的父结点的序号(n),每个节点只允许存在一个父结点，但允许存在多个子节点。
    - marker
        marker是Vaa3D平台一种用于标记的数据结构。此数据结构可以用来标记三维图像中的一些关键信息，比如神经元分叉点，神经元末梢等，也可以用于辅助一些自动示踪(Auto-trcing)算法的结果计算，例如标记自动算法的起始位置、收敛位置以及聚类中心等等。marker的实际数据结构如**表格和图**所示。
``` 表格
##x,y,z,radius,shape,name,comment, color_r,color_g,color_b
147.448, 122.709, 73.639, 0, 1, unknown, , 174,116,144
```
        在**表**中，第一至三列"x,y,z"表示marker在空间中的3D位置，第四列"radius"表示此marker的半径大小，第五列"shape"表示此marker的形状，第六列"name"表示此marker的名字,第七列"comment"表示针对此marker的注释信息，第八至十列"color_r,color_g,color_b"表示此marker的颜色信息，即R、G、B通道的值，与SWC中的type属性相同，在某些应用中，不同颜色的marker表示不同的意义。
 - image in VR 显示
    - opengl 显示
    - OpenGL 作为一个十分强大的3D图形开发工具，它本身不属于一种编程语言，它是图像硬件的软件接口，介于计算机图形与计算机硬件之间。OpenGL本身包含七百多个函数[]，本质上属于3D空间的图形和模型库。开发人员可以利用OpenGL构建3D模型和图像，并定义特定的交互操作。OpenGL具有十足的可移植性，它不依赖于操作系统和硬件环境，并且运行效率高，功能丰富。
        - OpenGL的主要功能：
            - 模型绘制
            - 基本坐标变换
            - 光照处理
            - 物体着色
            - 纹理映射
            - 动画效果
            - 位图和图像处理
            - 反走样
    - 在OpenGL中，点是最基本的图形单元，即定点(Vertex).所有的复杂图形都可以由一组定点的集合描述，顶点间如何连接决定了绘制的图形的类型。一般情况下，OpenGL中一个定点被画成单个像素(pixel)点.两个顶点的组合构成线段，OpenGl中的线段与数学定义中的线段不同，是有宽度的。多个线段首尾相连形成的笔和区域就构成了一个多边形，多边形一般由其各个端点来描述。 点、线段和多边形构成可OpenGL中的基本几何图元。
 - SWC 显示
    - 在本虚拟现实系统中，SWC会存在两种不同的显示方式：skeleton模式和surface模式。
    - skeleton模式：使用固定宽度的线段将节点与节点之间连接起来，所有数据中的节点全部连接后最终形成一条连续的曲线**图**。此模式下，我们能够更直观地看到整个NeuronTree/节点树的拓扑结构，能够更清晰地看到整个神经元结构的分支数和走向，更能轻易分辨出整个节点树中的关键节点。 
        -  跟据SWC的数据结构，我们用OpenGL中的单个顶点表示SWC中的每个node，用顶点的坐标表示node在三维空间中的位置，用顶点之间连接而成的线段表示node之间的父子关系，用线段的颜色表示node的type。
        实现步骤：
        1. 生成并绑定SWC某个segment的VAO&VBO；
        ``` C++
        //setup vao and vbo stuff
        glGenVertexArrays(1, &LineModeVAO);
        glGenBuffers(1, &LineModeVBO);
        glGenBuffers(1, &LineModeIndex);

        //now allocate buffers
        glBindVertexArray(LineModeVAO);

        glBindBuffer(GL_ARRAY_BUFFER, LineModeVBO);
        glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, LineModeIndex);

        glEnableVertexAttribArray(0);
        glVertexAttribPointer(0, 3, GL_FLOAT, GL_FALSE, 2*sizeof(glm::vec3), (GLvoid*)0);
        uintptr_t offset =  sizeof( glm::vec3 );
        glEnableVertexAttribArray( 1 );
        glVertexAttribPointer( 1, 3, GL_FLOAT, GL_FALSE, 2*sizeof(glm::vec3), (const void *)offset);

        glBindVertexArray(0);
        ```
        2. 将SWC中的节点的空间坐标XYZ，父子关系和颜色信息type转换成OpenGl的顶点位置信息，绘制顺序和颜色信息，并拷贝到对应的VAO&VBO中；
``` C++
    vector <glm::vec3> vertices;
    vector<GLuint> indices;    
    NeuronSWC node = neuron_Tree.listNeuron.at(i);
    vertices.push_back(glm::vec3(node.x,node.y,node.z));//顶点位置信息
    vertices.push_back(glm::vec3(node.r,node.g,node.b));//顶点颜色信息
    indices.push_back(node);
    indices.push_back(node.parent);//绘制顺序数组

    glBufferData(GL_ARRAY_BUFFER, vertices.size() * sizeof(glm::vec3), &vertices[0],(drawMode==0)?GL_STATIC_DRAW:GL_DYNAMIC_DRAW);
    glBufferData(GL_ELEMENT_ARRAY_BUFFER, indices.size() * sizeof(GLuint), &indices[0],(drawMode==0)?GL_STATIC_DRAW: GL_DYNAMIC_DRAW);//将数据拷贝至对应的VAO&VBO中
```
        3. 在GPU中渲染对应的VAO&VBO;
``` C++
        //draw sketch lines
        glUseProgram(m_unControllerTransformProgramID);
        glUniformMatrix4fv(m_nControllerMatrixLocation, 1, GL_FALSE, model_M.get());
        glBindVertexArray(LineModeVAO);
        glDrawElements(GL_LINES, m_uiSketchMorphologyLineModeVertcount, GL_UNSIGNED_INT, 0);
```
    - surface模式： 此模式着重点在于显示神经元重建结构的3D表面信息，能够更加清晰直观地看到3D重建结果与实际三维图像数据的拟合程度。将node显示成sphere 将node之间的线段显示成cylinder 针对单个节点，我们会在对应的位置渲染一个颜色半径与该节点的数据结构相同的球体作为该节点的3D结构；针对节点之间的连接，我们会根据节点构成的线段的两个端点的半径大小和位置渲染出一个对应半径的圆台来表示。**图**
    实现步骤与关键代码：
    1.准备节点和其父结点的球的VAO&VBO
``` C++
    NeuronSWC node = neuron_Tree.listNeuron.at(i);
    //draw sphere
    spheres.push_back(new Sphere((float)(node.r)));//球的VAO&VBO
    spheresPos.push_back(glm::vec3(node.x,node.y,node.z));//空间坐标信息  
    
    // draw parent sphere
    NeuronSWC parent = node.parent;
    spheres.push_back(new Sphere((float)(parent.r)));//球的VAO&VBO
    spheresPos.push_back(glm::vec3(parent.x,parent.y,parent.z));//空间坐标信息  
```
    2.准备两个节点之间的圆台的 VAO&VBO
``` C++
    NeuronSWC node = neuron_Tree.listNeuron.at(i);
    NeuronSWC parent = node.parent;
    float dist = glm::sqrt((node.x-parent.x)*(node.x-parent.x)+(node.y-parent.y)*(node.y-parent.y)+(node.z-parent.z)*(node.z-parent.z));
    cylinders.push_back(new Cylinder(parent.r,node.r,dist));  
```
    3.在GPU中渲染对应的VAO&VBO;
``` C++
    Sphere* sphere = spheres.at(i);
    morphologyShader->setMat4("model", model);
    morphologyShader->setVec3("objectColor", sphere.color);
    glPolygonMode(GL_FRONT_AND_BACK, GL_FILL);
    sphere->Render();

    Cylinder* cylinder = cylinders.at(i);
    morphologyShader->setMat4("model", model);
    morphologyShader->setVec3("objectColor", cylinders.color);
    glPolygonMode(GL_FRONT_AND_BACK, GL_FILL);
    cylinder->Render();
```    

 - marker 显示: 在本虚拟现实系统中，marker的显示方式与Vaa3D平台普通的显示方式相似，都是将marker作为一个球体显示在对应的空间位置中。
 - volume rendering 显示 in VR
        根据摄像机位置发出的射线计算出新的立方体cube，将3Dimage显示在cube中，即可实现人可以走进图像中的效果。**图**
 - 图像变换
    - 根据图像size选定一个center position 和 global scale， 再结合当前VR环境的大小和位置，计算得到一个全局变换矩阵，global matrix，将整个3D Image图像显示在虚拟现实环境中心的位置，并缩放至一个合适的大小。

### 交互
 - 右手柄的平移旋转缩放操作
    按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入平移模式。接着触摸touchpad的上下左右方向即可让整体图象沿着右手柄射线方向为基准的上下左右方向移动，抬起手指即可停止平移。 **公式 矩阵平移**  
    再次按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入旋转模式。接着触摸touchpad的上下左右方向即可让整体图象沿着对应方向旋转，抬起手指即可停止旋转。 **公式 矩阵旋转**  
    再次按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入缩放模式。接着触摸touchpad的上方向即可让整体图象放大；触摸touchpad的下方向即可让整体图象缩小，抬起手指即可停止缩放。 **公式 矩阵缩放**    
    再次按下右手柄触摸板，显示如图的UI贴图时，表示当前为非功能模式，即使触摸到touchpad也不会产生任何影响。
 - 左手柄的快捷平移旋转操作
    同时，我们为VR添加了另一种更加快捷的平移旋转方式，只需要持续按住左手柄的扳机(trigger)，整个图像/空间就会随着左手柄的旋转和平移来进行对应的变换操作，接着再松开左手柄扳机即可固定住当前的角度和位置。**公式 矩阵变换**
 - 图像对比度/亮度调整
    在一般情况下，即不调整任何显示参数的情况下，图像中的某些信号较低的区域在VR场景中是不可见或者不太清晰的，（同样，在于Vaa3D的2D 屏幕上也是不可见的）**对比图如图** 多数情况下，这些亮度/信号强度较为微弱的信号/区域我们可以认定为噪声信号，但同时这些信息在很多时候对于我们来说是有用的，因此我们需要实现在VR中也可以清晰看到这些微弱信号的方法。通过调整图像显示的对比度和亮度可以将这些微弱信号清晰地显示出来。
    按下左手柄的grip button，也就是我们的Switch Control 按钮，直到显示如图的UI贴图时，表示此时进入了对比度调整模式。按下贴图中对应的+/-键即可控制图像对比度的增减。对比度的范围控制在[0,50]的范围内。  
    按下左手柄的grip button，也就是我们的Switch Control 按钮，直到显示如图的UI贴图时，表示此时进入了亮度调整模式。按下贴图中对应的+/-键即可控制图像亮度的增减。亮度的范围控制在[0,100]的范围内。
 - neuron tracing in VR
    - [设计理念]首先我们需要实现的操作是，在虚拟现实环境中可以对图像信号进行手工描绘，也就是专业术语中的neuron tracing。作为生物学家可能最经常使用的功能，我们需要尽可能的方便/简化用户的操作，因此我们将右手柄的默认模式设置为画线模式/trace模式，只需要按下扳机即可进行操作。
    - [实现方法] 按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了画线模式。此模式下，持续按下右手柄的扳机键，即可在手柄中心位置，即位置**N**的球处，根据手柄移动的轨迹，持续生成连续曲线。当用户在虚拟现实环境下进行neuron tracing的工作时，只需要按下扳机并沿着需要trace的位置移动手柄，即可完成对图像信号的描绘。
    - 在实际的tracing工作中，必定会产生各种各样的误差操作或者错误操作，因此我们需要实现纠错的功能。我们为此系统设计了两种不同的纠错功能：1. 删除模式。 此模式下，只需要在想要删除的segment附近按下扳机，即可将此segment删除，此模式适用于整条segment误差过大或者未知错误的情况；2.移动模式。 此模式适用于整条segment中只有单个或者少量node误差过大的情况，此模式下在想要纠错/移动的node附近按下扳机即可对此node进行拖拽，松开扳机即可将此node固定在当前手柄位置处。
    - 按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了删除模式。此模式下只需要在想要删除的segment附近按下扳机，即可将此segment删除。 再次按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了移动模式。此模式下在想要纠错/移动的node附近按下扳机即可对此node进行拖拽，松开扳机即可将此node固定在当前手柄位置处。
    - 实际的tracing工作中，专家们经常会需要用到marker来对关键node或者关键位置进行标记，而且有些autotracing 重建算法也依赖于专家们标记的marker来产生更为精确的重建结果。因此，我们需要在虚拟现实环境下同样实现marker的增删操作。marker的增删功能的设计理念与线大致相似，在新增marker模式下，按下右手柄扳机即可在当前手柄位置生成一个球作为marker显示在对应位置；在删除marker模式下，在想要删除的marker的附近按下右手柄扳机即可删除对应marker。
    - 按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了新增marker模式。此模式下按下右手柄扳机即可在当前手柄位置生成一个球作为marker显示在对应位置。 再次按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了删除marker模式。此模式下在想要删除的marker的附近按下右手柄扳机即可删除对应marker。
    - [颜色调整]SWC中，每个node均有一个共同的属性，就是type。不同的type表示SWC中的node代表不同的意义，在Vaa3D中以不同颜色来进行区分，例如：type = 0，颜色为 white[0xffffff]表示该node属于。。。 type = 1，颜色为 black[0x000000]表示该node属于。。。。**列个表格？** 另一方面，每一个marker也都拥有一个color属性，意义大致等同于node的type。因此在虚拟现实环境下我们也需要能画出不同颜色不同type的segment和marker。按下左手柄的grip button，也就是我们的Switch Control 按钮，直到显示如图的UI贴图时，表示此时进入了颜色切换模式。我们选取了7种最常用的有明确意义的颜色做为虚拟现实环境下的注释annotation的颜色，按下touchpad即可在这7种颜色重进行循环切换，同时右手柄中心位置出现实的球的颜色也同步会切换为当前选定的注释颜色，此后无论是画线的颜色还是标记marker的颜色都会以当前选定的颜色显示，但之前已经画的线和标记的marker的颜色不会改变。
    - [保存]在使用过程中，随时按下右手柄上方的save button 如图，即可将当前的工作保存下来，所有的segment都会被合并为一条完整的neuron tree保存在当前exe目录下，命名格式为`******`+当前时间.swc，所有的marker都会被保存在当前恶心恶目录下，命名格式为`********`+当前时间.marker。当当前工作进行到一定阶段，可以随时保存，当下一阶段工作开始后重新载入上次工作保存下来的文件，继续展开后续的工作。
    - [撤销重做]撤消重做是一个文档编辑或者其他编辑时常用的基本功能，我们在本系统中，也实现了SWC标注操作的撤消重做功能。撤消重做功能一般有两种方案：恢复数据和恢复操作。本系统中选择的是恢复数据的方案。具体方案是当用户每次进行SWC标记操作之后，将旧数据保存至一个单独的固定大小的栈(unod_stack)中，系统限制最大的撤销次数为5次，达到最大撤销次数之后，每次SWC标注操作产生后，将栈中最旧的数据删除，再将此次数据保存至栈中；当用户每次进行撤销操作时，将旧数据保存至一个单独的固定大小的栈（定义为redo_stack）中，从撤销的栈(undo_stack)中取出最新的一份数据当作当前整个工作环境的数据，redo_stack的大小限制也是5；当用户每次进行重做操作之后，从重做的栈(redo_stack)中取出一份最新的数据当作整个工作环境的数据，然后清空整个撤销的栈(undo_stack)。
### 联网
 - 具体内容在另一个文件中
 - 联网流程图
 - 消息广播流程图

# 第四章 虚拟现实环境中的智能交互方式
<!-- # 第四章 改进的Virtual Finger算法在VR环境下的实现 -->  
 - 传统的基于Vaa3D平台的进行神经元形态重建的工作流程中，一般存在三种工作方式，分别是 手动重建方法(Manual tracing)、自动重建方法(Auto tracing)和半自动重建方法(Semi-auto tracing)。手动重建方法指的是完全依靠生物专家或研究者在屏幕上根据所见到的图像信号进行追踪与标注的方法。
 - 手动的方法完全依赖人工操作，虽然精确性得到保障，但会耗费用户大量的精力与时间。一个小鼠的全脑的所有神经元的标注可能需要多个生物专家协同工作数周甚至数月时间才能完成。 
 - 与之相反，自动重建方法指的是完全不依赖任何人工干预和操作，基于计算机的自动重建算法，自动地根据图像信号来进行神经元形态重建的方法。自动的重建方法省去了大量的用户的精力和时间，利用计算机自动地生成神经元的重建结果的速度远远快于人工的重建的速度，但由于当前自动重建算法的研究的限制，很难出现一种自动重建算法能够兼顾重建速度和重建结果的正确性，也缺少能够良好应用于多种复杂图像的自动重建算法。 
 - 半自动重建方法指的是在计算机自动计算重建结果的输入，输出以及计算过程中施以一些人为的干预的重建方法。这些人为的干预可能包括：(i)在图像数据中人为地标注出重建算法的起始点或者收敛点；(ii)对重建算法的重建结果进行人为的筛选或者修剪；(iii)对重建算法的中间结果进行人为的筛选等等。半自动的重建方法相比完全自动的重建方法来说，重建结果的准确性更好，更符合生物学专家对于重建结果的期望，而且相比纯手动的重建方法，速度和效率都有很大程度的提升。但仍然需要一定的人工干预的特点决定了半自动的重建方法无法适用于大批量神经元数据的重建工作，需要针对每个单独的神经元数据进行一定的人为干预，而不是像自动重建方法可以自动遍历所有神经元数据从而得到重建结果。
 - 本系统作为一个脑图像数据的可视化和交互系统，在第三章中已经描述了使用手柄控制器进行手动重建的工作流程。与此同时，我们也设计为用户提供一种虚拟现实环境中的智能交互方式，可以为用户实现一种更为方便高效的半自动重建方法。该智能交互方式的设计方案为：用户仍然使用手柄控制器来进行SWC标注操作，但在智能交互模式下，即使用户使用手柄控制器随意操作，比如沿着图像信号速度很快的描过去，系统会根据这条比较随意的轨迹与图像信号计算出一条更加贴合图像信号的曲线。在智能交互模式下，用户的输入是一条粗略的节点数较少的折线，输出则是一条自动贴合图像信号且重新采样的SWC。


## Virtual Finger算法
 - Virtual Finger算法以鲁棒有效的方式生成三维空间中的点，曲线和感兴趣区域（ROI，Region of Interest）。只要这些对象在2D的显示屏幕中是可见的，只需单击鼠标或者移动鼠标（或者其他类似的输入设备（如数字化笔或触摸屏）的等效操作）即可使Virtual Finger算法在图像数据中计算出并显示其在三维空间中的位置。 VF技术允许对复杂3D图像内容进行即时和随机顺序的探索，就像我们的真实手指使用单击或笔画探索真实的3D世界来定位3D对象。
 - Virtual Finger算法是一系列满足3D-WYSIWYG（"What you see in 2D is what you get in 3D"）基本特征的算法的集合，将用户在计算机屏幕的2D平面中的输入映射到生物实体（例如，细胞 ，神经元等）的3D图像数据在三维空间中的位置。 Virtual Finger算法得到的三种对象对应于典型光学显微镜图像中的重要结构：（i）3D点可以标记标记细胞或蛋白质的位置；（ii）3D曲线可对应于一般血管类结构，如微管，血管，支气管树 或神经突触等；(iii)3D ROI可以突出特定细胞群或脑室。

 - Virtual Finger算法进行神经元重建的具体步骤
    - 1. 获取用户在2D屏幕上的输入(in this case, it is a curve defined by mouse move)
    - 2. 将用户输入的曲线重采样得到N条从屏幕射向3D图像数据的射线；
    - 3. 使用PPA算法计算得到3D图像数据中的N*m个点(m表示每条射线在3D图像数据中可能命中的3D点的个数)；
    - 4. 以这N*m个点作为输入，根据图像数据，使用fast marching算法[]计算每两条射线之间的最短测地路径[];
    - 5. 最终得到多条从起始射线到达最终射线的局部最短路径，排序后得到一条最短的全局最短路径。
    - 6. 根据全局最短路径生成对应的3D 曲线，也就是SWC曲线，并显示在2D屏幕中。
- 介绍fastmarching 算法？
- **算法示意图**

## 在VR中的改进的 Virtual Finger算法
- 算法的在VR场景中的应用局限
    - 传统的2D屏幕获得的用户输入只能是一系列二维的坐标(x,y), 需要通过算法计算得到/估计用户输入的二维坐标在三维图像数据中的对应的三维位置(X,Y,Z), 但在虚拟现实环境下，得到的用户输入始终是一个三维的坐标，而且能够与三维图像数据中的位置对应起来。
- 首次输入 从屏幕的XY变成了VR空间中的XYZ
- 结果输出 从根据图像角度只做某一个方向上的投影 变成了  遍历三次，分别做X、Y、Z方向上的投影
- 考虑VR空间中可能会额外存在界外的情况
- 虚拟现实环境中使用智能交互进行神经元重建的具体步骤
    - 1. 获取用户在虚拟现实环境下的输入，即用户交互操作发生时的手柄控制器的中心3D位置(Xc,Yc,Zc)最终形成的连续曲线;
    - 2. 对这条曲线进行重采样得到N个 3D点；
    - 3. 对N个3D点进行筛选，剔除不属于三维图像数据包围盒内的点，最终得到N'的3D点；
    - 4. 以这N'个3D点作为输入，根据图像数据，使用Virtual Finger算法得到一条贴合图像数据的连续曲线;
    - 5. XYZ各个平面的投影？
- **算法流程图**

# 实验

# 结论与展望

# 参考文献

# 致谢