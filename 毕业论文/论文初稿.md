# 第三章 Vaa3D平台中虚拟现实显示与交互的引入
## 系统设计
    - 系统设计目标
        原始的Vaa3D平台中，虽然已经可以显示并处理3D医学图像，但始终是在2D屏幕上操作3D的模型/图像，难以直观地从各个角度观察3D图像，使用鼠标对图像进行平移旋转缩放等操作十分的笨拙，更难以对图像的某个位置进行精确的定位与进一步的标记操作。 因此我们预想为Vaa3D 平台引入新型的显示方式，即将这些3D医学图像显示在虚拟现实环境中，可以更为直观地观察到整个3D图像的立体结构，即便没有实现任何的图像平移旋转操作，也可以通过在虚拟现实环境中的任意走动与VR头盔角度的任意变换，十分方便的就能观察到3D图像各个角度各个维度的图像特征。 更何况我们还可以在虚拟现实环境中直接对3D图像进行各种直观操作，例如通过手柄对3D图像进行平移旋转缩放等操作，结合用户走动与VR头盔的旋转，极大地方便了用户对3D图像的各个维度各个角度的观察，提升了用户的使用体验，进一步提升用户的工作效率。另一方面，我们预想为Vaa3D平台在虚拟现实环境中引入新型的交互方式，使得之前在2D屏幕上通过鼠标键盘能够实现的操作，例如 trace one single neuron，define a marker, edit one single neuron等 都能够在虚拟现实环境中实现，甚至某些操作在引入虚拟现实环境中后能得到优化，进一步提升用户的工作效率。
    - 系统设计架构
        画一个系统架构图
    - 系统需求分析图****
## 系统实现
### 显示
 - image in VR 显示
    - 参考 彭老师 论文 翻译过来
    - volume rendering 显示 in VR
        根据摄像机位置发出的射线计算出新的立方体cube，将3Dimage显示在cube中，即可实现人可以走进图像中的效果。****
 - SWC 显示
    - skeleton模式：根据多个点 openGL 显示线
    - surface模式： 将node显示成sphere 将node之间的线段显示成cylinder
 - marker 显示
    - 准备sphere 将每个marker作为一个sphere显示
 - 图像变换
    - 根据图像size选定一个center position 和 global scale， 再结合当前VR环境的大小和位置，计算得到一个全局变换矩阵，global matrix，将整个3D Image图像显示在虚拟现实环境中心的位置，并缩放至一个合适的大小。

### 交互
 - 右手柄的平移旋转缩放操作
    按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入平移模式。接着触摸touchpad的上下左右方向即可让整体图象沿着右手柄射线方向为基准的上下左右方向移动，抬起手指即可停止平移。 **公式 矩阵平移**  
    再次按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入旋转模式。接着触摸touchpad的上下左右方向即可让整体图象沿着对应方向旋转，抬起手指即可停止旋转。 **公式 矩阵旋转**  
    再次按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入缩放模式。接着触摸touchpad的上方向即可让整体图象放大；触摸touchpad的下方向即可让整体图象缩小，抬起手指即可停止缩放。 **公式 矩阵缩放**    
    再次按下右手柄触摸板，显示如图的UI贴图时，表示当前为非功能模式，即使触摸到touchpad也不会产生任何影响。
 - 左手柄的快捷平移旋转操作
    同时，我们为VR添加了另一种更加快捷的平移旋转方式，只需要持续按住左手柄的扳机(trigger)，整个图像/空间就会随着左手柄的旋转和平移来进行对应的变换操作，接着再松开左手柄扳机即可固定住当前的角度和位置。**公式 矩阵变换**
 - 图像对比度/亮度调整
    在默认的情况下，图像中的某些信号较低的区域在VR场景中是不可见或者不太清晰的，（同样，在于Vaa3D的2D 屏幕上也是不可见的）但这些信息在很多时候对于我们来说是有用的
    按下左手柄的grip button，也就是我们的Switch Control 按钮，直到显示如图的UI贴图时，表示此时进入了对比度调整模式。