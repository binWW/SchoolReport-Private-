# 第三章 Vaa3D平台中虚拟现实显示与交互的引入
## 系统设计
    - 系统设计目标
        原始的Vaa3D平台中，虽然已经可以显示并处理3D医学图像，但始终是在2D屏幕上操作3D的模型/图像，难以直观地从各个角度观察3D图像，使用鼠标对图像进行平移旋转缩放等操作十分的笨拙，更难以对图像的某个位置进行精确的定位与进一步的标记操作。 因此我们预想为Vaa3D 平台引入新型的显示方式，即将这些3D医学图像显示在虚拟现实环境中，可以更为直观地观察到整个3D图像的立体结构，即便没有实现任何的图像平移旋转操作，也可以通过在虚拟现实环境中的任意走动与VR头盔角度的任意变换，十分方便的就能观察到3D图像各个角度各个维度的图像特征。 更何况我们还可以在虚拟现实环境中直接对3D图像进行各种直观操作，例如通过手柄对3D图像进行平移旋转缩放等操作，结合用户走动与VR头盔的旋转，极大地方便了用户对3D图像的各个维度各个角度的观察，提升了用户的使用体验，进一步提升用户的工作效率。另一方面，我们预想为Vaa3D平台在虚拟现实环境中引入新型的交互方式，使得之前在2D屏幕上通过鼠标键盘能够实现的操作，例如 trace one single neuron，define a marker, edit one single neuron等 都能够在虚拟现实环境中实现，甚至某些操作在引入虚拟现实环境中后能得到优化，进一步提升用户的工作效率。
    - 系统设计架构
        画一个系统架构图
    - 系统需求分析图****
## 系统实现
### 显示
 - image in VR 显示
    - 参考 彭老师 论文 翻译过来
    - volume rendering 显示 in VR
        根据摄像机位置发出的射线计算出新的立方体cube，将3Dimage显示在cube中，即可实现人可以走进图像中的效果。****
 - SWC 显示
    - skeleton模式：根据多个点 openGL 显示线
    - surface模式： 将node显示成sphere 将node之间的线段显示成cylinder
 - marker 显示
    - 准备sphere 将每个marker作为一个sphere显示
 - 图像变换
    - 根据图像size选定一个center position 和 global scale， 再结合当前VR环境的大小和位置，计算得到一个全局变换矩阵，global matrix，将整个3D Image图像显示在虚拟现实环境中心的位置，并缩放至一个合适的大小。

### 交互
 - 右手柄的平移旋转缩放操作
    按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入平移模式。接着触摸touchpad的上下左右方向即可让整体图象沿着右手柄射线方向为基准的上下左右方向移动，抬起手指即可停止平移。 **公式 矩阵平移**  
    再次按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入旋转模式。接着触摸touchpad的上下左右方向即可让整体图象沿着对应方向旋转，抬起手指即可停止旋转。 **公式 矩阵旋转**  
    再次按下右手柄的触摸板，显示如图的UI贴图时，表示此时已经进入缩放模式。接着触摸touchpad的上方向即可让整体图象放大；触摸touchpad的下方向即可让整体图象缩小，抬起手指即可停止缩放。 **公式 矩阵缩放**    
    再次按下右手柄触摸板，显示如图的UI贴图时，表示当前为非功能模式，即使触摸到touchpad也不会产生任何影响。
 - 左手柄的快捷平移旋转操作
    同时，我们为VR添加了另一种更加快捷的平移旋转方式，只需要持续按住左手柄的扳机(trigger)，整个图像/空间就会随着左手柄的旋转和平移来进行对应的变换操作，接着再松开左手柄扳机即可固定住当前的角度和位置。**公式 矩阵变换**
 - 图像对比度/亮度调整
    在一般情况下，即不调整任何显示参数的情况下，图像中的某些信号较低的区域在VR场景中是不可见或者不太清晰的，（同样，在于Vaa3D的2D 屏幕上也是不可见的）**对比图如图** 多数情况下，这些亮度/信号强度较为微弱的信号/区域我们可以认定为噪声信号，但同时这些信息在很多时候对于我们来说是有用的，因此我们需要实现在VR中也可以清晰看到这些微弱信号的方法。通过调整图像显示的对比度和亮度可以将这些微弱信号清晰地显示出来。
    按下左手柄的grip button，也就是我们的Switch Control 按钮，直到显示如图的UI贴图时，表示此时进入了对比度调整模式。按下贴图中对应的+/-键即可控制图像对比度的增减。对比度的范围控制在[0,50]的范围内。  
    按下左手柄的grip button，也就是我们的Switch Control 按钮，直到显示如图的UI贴图时，表示此时进入了亮度调整模式。按下贴图中对应的+/-键即可控制图像亮度的增减。亮度的范围控制在[0,100]的范围内。
 - neuron tracing in VR
    - [设计理念]首先我们需要实现的操作是，在虚拟现实环境中可以对图像信号进行手工描绘，也就是专业术语中的neuron tracing。作为生物学家可能最经常使用的功能，我们需要尽可能的方便/简化用户的操作，因此我们将右手柄的默认模式设置为画线模式/trace模式，只需要按下扳机即可进行操作。
    - [实现方法] 按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了画线模式。此模式下，持续按下右手柄的扳机键，即可在手柄中心位置，即位置**N**的球处，根据手柄移动的轨迹，持续生成连续曲线。当用户在虚拟现实环境下进行neuron tracing的工作时，只需要按下扳机并沿着需要trace的位置移动手柄，即可完成对图像信号的描绘。
    - 在实际的tracing工作中，必定会产生各种各样的误差操作或者错误操作，因此我们需要实现纠错的功能。我们为此系统设计了两种不同的纠错功能：1. 删除模式。 此模式下，只需要在想要删除的segment附近按下扳机，即可将此segment删除，此模式适用于整条segment误差过大或者未知错误的情况；2.移动模式。 此模式适用于整条segment中只有单个或者少量node误差过大的情况，此模式下在想要纠错/移动的node附近按下扳机即可对此node进行拖拽，松开扳机即可将此node固定在当前手柄位置处。
    - 按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了删除模式。此模式下只需要在想要删除的segment附近按下扳机，即可将此segment删除。 再次按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了移动模式。此模式下在想要纠错/移动的node附近按下扳机即可对此node进行拖拽，松开扳机即可将此node固定在当前手柄位置处。
    - 实际的tracing工作中，专家们经常会需要用到marker来对关键node或者关键位置进行标记，而且有些autotracing 重建算法也依赖于专家们标记的marker来产生更为精确的重建结果。因此，我们需要在虚拟现实环境下同样实现marker的增删操作。marker的增删功能的设计理念与线大致相似，在新增marker模式下，按下右手柄扳机即可在当前手柄位置生成一个球作为marker显示在对应位置；在删除marker模式下，在想要删除的marker的附近按下右手柄扳机即可删除对应marker。
    - 按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了新增marker模式。此模式下按下右手柄扳机即可在当前手柄位置生成一个球作为marker显示在对应位置。 再次按下右手柄的grip button，也就是我们的Switch Control按钮，直到显示如图的UI贴图时，表示此时进入了删除marker模式。此模式下在想要删除的marker的附近按下右手柄扳机即可删除对应marker。
    - [颜色调整]SWC中，每个node均有一个共同的属性，就是type。不同的type表示SWC中的node代表不同的意义，在Vaa3D中以不同颜色来进行区分，例如：type = 0，颜色为 white[0xffffff]表示该node属于。。。 type = 1，颜色为 black[0x000000]表示该node属于。。。。**列个表格？** 另一方面，每一个marker也都拥有一个color属性，意义大致等同于node的type。因此在虚拟现实环境下我们也需要能画出不同颜色不同type的segment和marker。按下左手柄的grip button，也就是我们的Switch Control 按钮，直到显示如图的UI贴图时，表示此时进入了颜色切换模式。我们选取了7种最常用的有明确意义的颜色做为虚拟现实环境下的注释annotation的颜色，按下touchpad即可在这7种颜色重进行循环切换，同时右手柄中心位置出现实的球的颜色也同步会切换为当前选定的注释颜色，此后无论是画线的颜色还是标记marker的颜色都会以当前选定的颜色显示，但之前已经画的线和标记的marker的颜色不会改变。
    - [保存]在使用过程中，随时按下右手柄上方的save button 如图，即可将当前的工作保存下来，所有的segment都会被合并为一条完整的neuron tree保存在当前exe目录下，命名格式为`******`+当前时间.swc，所有的marker都会被保存在当前恶心恶目录下，命名格式为`********`+当前时间.marker。当当前工作进行到一定阶段，可以随时保存，当下一阶段工作开始后重新载入上次工作保存下来的文件，继续展开后续的工作。
    - [撤销重做]**撤销重做操作的重要性介绍**